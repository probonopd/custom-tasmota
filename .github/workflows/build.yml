name: Build

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      VARIANTS: '["tasmota", "tasmota-4M", "tasmota32s2cdc", "tasmota32s3-qio_opi-all", "tasmota32s3-qio_opi_120"]'

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install PlatformIO and jq
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip jq
          pip3 install platformio

      - name: Git clone Tasmota
        run: |
          git clone --single-branch --depth 1 https://github.com/arendst/Tasmota # -b 'v14.4.1'
          # Patch for AAC support
          # wget https://patch-diff.githubusercontent.com/raw/arendst/Tasmota/pull/22787.diff
          # cd Tasmota/
          # patch -p 1 < ../22787.diff
          # cd -

      - name: Copy user_config_override.h and change xdrv_01_9_webserver.ino
        run: |
          sed -i -e 's|http://ota.tasmota.com/tasmota/release/|https://github.com/${GITHUB_REPOSITORY}/releases/download/continuous/|g' Tasmota/platformio_tasmota_env.ini
          sed -i -e 's|http://ota.tasmota.com/tasmota/release/|https://github.com/${GITHUB_REPOSITORY}/releases/download/continuous/|g' Tasmota/platformio_tasmota_env32.ini
          cp user_config_override.h Tasmota/tasmota/user_config_override.h
          sed -i -e "s|>Tasmota |>Based on Tasmota|g" Tasmota/tasmota/tasmota_xdrv_driver/xdrv_01_9_webserver.ino
          sed -i -e "s|Theo Arends</a>|Theo Arends</a><br><a href=\'https://github.com/${GITHUB_REPOSITORY}/commit/${GITHUB_SHA}\'>https://github.com/${GITHUB_REPOSITORY}</a>|g" Tasmota/tasmota/tasmota_xdrv_driver/xdrv_01_9_webserver.ino
          sed -i -e 's|verdana,sans-serif|helvetica,sans-serif|g' Tasmota/tasmota/html_uncompressed/HTTP_HEAD_STYLE1.h # Proper font; FIXME: Does not work?
      - name: Build Tasmota variants
        run: |
          cd Tasmota
          mkdir -p ../out/
          for variant in $(echo $VARIANTS | jq -r '.[]'); do
            platformio run -e "$variant"
            mv .pio/build/*/firmware.bin "../out/${variant}.bin"
            gzip -c "../out/${variant}.bin" > "../out/${variant}.bin.gz"
          done

      - name: Check for existing release
        id: check_release
        run: |
          release=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/continuous")
          echo "exists=$(echo $release | jq -r '.id // null')" >> $GITHUB_ENV

      - name: Delete existing release
        if: env.exists != 'null'
        run: |
          curl -X DELETE -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/${{ env.exists }}"

      - name: Create new release
        id: create_release
        run: |
          response=$(curl -X POST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -d '{"tag_name": "continuous", "name": "Continuous Release", "body": "Customized builds of Tasmota"}' \
            "https://api.github.com/repos/${{ github.repository }}/releases")
          echo "release_id=$(echo $response | jq '.id')" >> $GITHUB_ENV

      - name: Upload artifacts to release
        run: |
          for variant in $(echo $VARIANTS | jq -r '.[]'); do
            for file_type in "bin" "bin.gz"; do
              curl -X POST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Content-Type: application/octet-stream" \
                --data-binary @"out/${variant}.${file_type}" \
                "https://uploads.github.com/repos/${{ github.repository }}/releases/${{ env.release_id }}/assets?name=${variant}.${file_type}"
            done
          done
